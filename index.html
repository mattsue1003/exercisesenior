<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é•·è€…é‹å‹•æ•™æ¡ˆè³‡æ–™åº« - åœ¨åœ°ç®¡ç†ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto+Sans+TC', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 12px;
        }
        .video-container iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .scroll-hint { position: relative; }
        .scroll-hint::after {
            content: '';
            position: absolute;
            right: 0; top: 0; bottom: 0;
            width: 40px;
            background: linear-gradient(to left, #f8fafc, transparent);
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen pb-24 md:pb-8">

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- æ¨™é¡Œæ¬„ -->
        <header class="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
                    <span class="bg-blue-600 text-white p-2 rounded-xl shadow-md">
                        <i data-lucide="database" size="24"></i>
                    </span>
                    é•·è€…é‹å‹•æ•™æ¡ˆè³‡æ–™åº«
                </h1>
                <p class="text-slate-500 mt-1 text-sm md:text-base">åœ¨åœ°å„²å­˜ç‰ˆ Â· ç„¡éœ€é›²ç«¯ Â· æ°¸ä¸æ¶ˆå¤±</p>
            </div>
            <div class="hidden md:flex gap-3">
                <button onclick="toggleCart()" class="relative bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 px-5 py-2.5 rounded-xl flex items-center gap-2 transition-all shadow-sm">
                    <i data-lucide="shopping-basket" size="20"></i>
                    æŸ¥çœ‹èœå–®
                    <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center font-bold shadow-sm">0</span>
                </button>
                <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 transition-all shadow-md">
                    <i data-lucide="plus" size="20"></i>
                    æ–°å¢æ•™æ¡ˆ
                </button>
            </div>
        </header>

        <!-- æœå°‹èˆ‡ç¯©é¸ -->
        <div class="bg-white p-4 md:p-5 rounded-2xl shadow-sm border border-slate-100 mb-6 flex flex-col gap-4">
            <div class="relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="20"></i>
                <input type="text" id="searchInput" placeholder="æœå°‹åç¨±æˆ–åˆ†é¡ (å¦‚ï¼šæ°£åŠŸã€å¤§è…¦ã€ä¼¸å±•)..." oninput="filterVideos()" class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all text-base">
            </div>
            <div class="scroll-hint">
                <div class="flex overflow-x-auto gap-2 pb-2 no-scrollbar" id="categoryFilters"></div>
            </div>
        </div>

        <!-- å½±ç‰‡ç¶²æ ¼ -->
        <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
            <!-- è³‡æ–™å°‡åœ¨æ­¤æ¸²æŸ“ -->
        </div>
    </div>

    <!-- æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°è¦½ -->
    <div class="fixed border-t border-slate-200 bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md md:hidden z-50 flex justify-around items-center p-3 safe-bottom">
        <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="flex flex-col items-center gap-1 text-slate-400">
            <i data-lucide="home" size="24"></i>
            <span class="text-[10px]">æ‰€æœ‰æ•™æ¡ˆ</span>
        </button>
        <button onclick="openModal()" class="flex flex-col items-center gap-1 text-slate-400">
            <i data-lucide="plus-square" size="24"></i>
            <span class="text-[10px]">æ–°å¢å½±ç‰‡</span>
        </button>
        <button onclick="toggleCart()" class="relative flex flex-col items-center gap-1 text-blue-600">
            <i data-lucide="clipboard-list" size="24"></i>
            <span class="text-[10px]">ä½œæ¥­èœå–®</span>
            <span id="cartCountMob" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold">0</span>
        </button>
    </div>

    <!-- å´é‚Šèœå–® -->
    <div id="cartSidebar" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl z-[70] translate-x-full transition-transform duration-300 ease-in-out border-l border-slate-100 flex flex-col">
        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-blue-50">
            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="list-checks" class="text-blue-600"></i>
                ä»Šæ—¥é‹å‹•èœå–®
            </h2>
            <button onclick="toggleCart()" class="text-slate-400 p-2"><i data-lucide="x"></i></button>
        </div>
        <div id="cartItems" class="flex-1 overflow-y-auto p-5 space-y-4"></div>
        <div class="p-5 border-t border-slate-100 space-y-4 bg-slate-50 safe-bottom">
            <p class="text-xs text-slate-400 text-center">èœå–®èˆ‡æ•™æ¡ˆçš†å­˜æ–¼æ­¤è£ç½®ï¼Œé‡æ–°æ•´ç†ä¸æœƒæ¶ˆå¤±</p>
            <textarea id="customMsg" rows="3" class="w-full p-3 text-sm border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="çµ¦é•·è¼©çš„é¼“å‹µè©±èª..."></textarea>
            <button onclick="exportAssignment()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95">
                <i data-lucide="share-2"></i>
                ç”Ÿæˆä¸¦è¤‡è£½ä½œæ¥­
            </button>
        </div>
    </div>

    <!-- ç·¨è¼¯å½ˆçª— -->
    <div id="videoModal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-[80] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-lg p-6 md:p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold text-slate-800">æ–°å¢æ•™æ¡ˆ</h2>
                <button onclick="closeModal()" class="text-slate-400 p-2"><i data-lucide="x"></i></button>
            </div>
            <input type="hidden" id="editId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">YouTube é€£çµ</label>
                    <input type="text" id="newUrl" placeholder="https://youtu.be/..." class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">å½±ç‰‡æ¨™é¡Œ</label>
                    <input type="text" id="newTitle" placeholder="ä¾‹å¦‚ï¼šå¹³ç”©åŠŸ-30åˆ†é˜" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">é‹å‹•åˆ†é¡</label>
                    <select id="newCategory" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                        <option value="æ°£åŠŸåŠŸæ³•">æ°£åŠŸåŠŸæ³•</option>
                        <option value="å®¤å…§æ•£æ­¥">å®¤å…§æ•£æ­¥</option>
                        <option value="å¥åº·æ“">å¥åº·æ“</option>
                        <option value="æœ‰æ°§é‹å‹•">æœ‰æ°§é‹å‹•</option>
                        <option value="é«˜é½¡è€…å°ˆé …">é«˜é½¡è€…å°ˆé …</option>
                        <option value="ä¼¸å±•é‹å‹•">ä¼¸å±•é‹å‹•</option>
                        <option value="è‚ŒåŠ›é‹å‹•">è‚ŒåŠ›é‹å‹•</option>
                        <option value="å¤§è…¦ä¿å¥">å¤§è…¦ä¿å¥</option>
                        <option value="å£è…”ååš¥">å£è…”ååš¥</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="closeModal()" class="flex-1 py-4 rounded-2xl font-bold border border-slate-200 text-slate-500">å–æ¶ˆ</button>
                    <button id="saveBtn" onclick="saveVideo()" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg">å„²å­˜æ•™æ¡ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é è¦½å½ˆçª— -->
    <div id="previewModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[90] p-0 md:p-4">
        <div class="bg-black md:rounded-3xl overflow-hidden w-full max-w-4xl shadow-2xl flex flex-col h-full md:h-auto">
            <div class="flex justify-between items-center p-4 bg-white">
                <h3 id="previewTitle" class="font-bold text-lg text-slate-800 truncate pr-4">å½±ç‰‡é è¦½</h3>
                <button onclick="closePreview()" class="bg-slate-100 p-2 rounded-full text-slate-500"><i data-lucide="x"></i></button>
            </div>
            <div class="video-container flex-1 bg-black" id="previewVideoContainer"></div>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // åœ¨åœ°å„²å­˜é‚è¼¯ (LocalStorage)
        // ---------------------------------------------------------
        const VIDEO_STORAGE_KEY = 'elderly_exercise_videos_v2';
        const CART_STORAGE_KEY = 'elderly_exercise_cart_v2';

        let allVideos = [];
        let cart = [];
        let currentCategory = 'å…¨éƒ¨';

        const categories = ['å…¨éƒ¨', 'æ°£åŠŸåŠŸæ³•', 'å®¤å…§æ•£æ­¥', 'å¥åº·æ“', 'æœ‰æ°§é‹å‹•', 'é«˜é½¡è€…å°ˆé …', 'ä¼¸å±•é‹å‹•', 'è‚ŒåŠ›é‹å‹•', 'å¤§è…¦ä¿å¥', 'å£è…”ååš¥'];

        // é è¨­ 33 å‰‡æ•™æ¡ˆ (å¦‚æœåœ¨åœ°è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œå‰‡è¼‰å…¥é€™äº›)
        const seedData = [
            { id: '1', title: "å¹³ç”©åŠŸ-30åˆ†é˜", url: "https://youtu.be/RZRnXkDmhyk", category: "æ°£åŠŸåŠŸæ³•" },
            { id: '2', title: "å®¤å…§æ•£æ­¥-20åˆ†é˜", url: "https://youtu.be/ShKiPXsNnak", category: "å®¤å…§æ•£æ­¥" },
            { id: '3', title: "å®¤å…§æ•£æ­¥-20åˆ†é˜", url: "https://youtu.be/2yBc-qPhF_M", category: "å®¤å…§æ•£æ­¥" },
            { id: '4', title: "å®¤å…§æ•£æ­¥-10åˆ†é˜", url: "https://youtu.be/0SRK8vquWjI", category: "å®¤å…§æ•£æ­¥" },
            { id: '5', title: "å®¤å…§æ•£æ­¥1000æ­¥-10åˆ†é˜", url: "https://youtu.be/z_yCQolzOfo", category: "å®¤å…§æ•£æ­¥" },
            { id: '6', title: "äº”è¡Œå¥åº·æ“-15åˆ†é˜", url: "https://youtu.be/RKB4NxhENyY", category: "å¥åº·æ“" },
            { id: '7', title: "åå·§æ‰‹å¥åº·æ“ - ç€Ÿç‘èµ°ä¸€å›-4åˆ†é˜", url: "https://youtu.be/YgFuMyozo2I", category: "å¥åº·æ“" },
            { id: '8', title: "æ‰‹æŒ‡æ›¼æ³¢-3åˆ†é˜", url: "https://youtu.be/dsr0rF2r4Ww", category: "å¥åº·æ“" },
            { id: '9', title: "ï¼¨ï¼©ï¼©ï¼´æœ‰æ°§é‹å‹•-10åˆ†é˜", url: "https://youtu.be/IRO6OY64jp0", category: "æœ‰æ°§é‹å‹•" },
            { id: '10', title: "å…«æ®µéŒ¦-16åˆ†é˜", url: "https://youtu.be/cvlwcIiOrq0", category: "æ°£åŠŸåŠŸæ³•" },
            { id: '11', title: "é¦™åŠŸ-15åˆ†é˜", url: "https://youtu.be/1b79K-RF1Vw", category: "æ°£åŠŸåŠŸæ³•" },
            { id: '12', title: "æ´»è¡€åŠŸ-40åˆ†é˜", url: "https://youtu.be/GJANLbCkYWw", category: "æ°£åŠŸåŠŸæ³•" },
            { id: '13', title: "ç”©æ‰‹åŠŸ10å¼-11åˆ†é˜", url: "https://youtu.be/ze0LuL5-sKw", category: "æ°£åŠŸåŠŸæ³•" },
            { id: '14', title: "æ‹æ‰“é•·å‘½åŠŸ-10åˆ†é˜", url: "https://youtu.be/XSyMomEGzvY", category: "æ°£åŠŸåŠŸæ³•" },
            { id: '15', title: "åå¼å…«æ®µéŒ¦-21åˆ†é˜", url: "https://youtu.be/D-Y-o9HrB7k", category: "æ°£åŠŸåŠŸæ³•" },
            { id: '16', title: "åŒ—å¸‚è¡›ç”Ÿå±€ï¼šé«˜é½¡è€…æœ‰æ°§é‹å‹•å¥åº·æ“", url: "https://youtu.be/7pIeSsndwbA", category: "æœ‰æ°§é‹å‹•" },
            { id: '17', title: "åŒ—å¸‚è¡›ç”Ÿå±€ï¼šé«˜é½¡è€…ä¼¸å±•é‹å‹•å¥åº·æ“", url: "https://youtu.be/I5dOgCz8ms8", category: "ä¼¸å±•é‹å‹•" },
            { id: '18', title: "åŒ—å¸‚è¡›ç”Ÿå±€ï¼šé«˜é½¡è€…å½ˆåŠ›å¸¶é‹å‹•", url: "https://youtu.be/ROwOcKEKd9Q", category: "è‚ŒåŠ›é‹å‹•" },
            { id: '19', title: "é«˜é½¡è€…å¥åº·æ“", url: "https://youtu.be/_w50TfdCmKU", category: "é«˜é½¡è€…å°ˆé …" },
            { id: '20', title: "ç¬¬ä¸€å¥— è·‘æ­¥æœ‰æ°§", url: "http://youtu.be/FyWCq0erv5Y", category: "æœ‰æ°§é‹å‹•" },
            { id: '21', title: "ç¬¬äºŒå¥— æ¸¸æ³³æœ‰æ°§", url: "http://youtu.be/NmCpBUWtPCE", category: "æœ‰æ°§é‹å‹•" },
            { id: '22', title: "ç¬¬ä¸‰å¥— æ­¦è¡“æœ‰æ°§", url: "http://youtu.be/g2KCXhTMVdk", category: "æœ‰æ°§é‹å‹•" },
            { id: '23', title: "ç¬¬å››å¥— å¤ªæ¥µæœ‰æ°§", url: "http://youtu.be/PAbEW2ZetfM", category: "æœ‰æ°§é‹å‹•" },
            { id: '24', title: "ç¬¬äº”å¥— è‚©å¸¶é‹å‹•", url: "http://youtu.be/_RlMkDgILM4", category: "è‚ŒåŠ›é‹å‹•" },
            { id: '25', title: "ç¬¬å…­å¥— æ ¸å¿ƒé‹å‹•", url: "http://youtu.be/hcBJKlfsG4I", category: "è‚ŒåŠ›é‹å‹•" },
            { id: '26', title: "ç¬¬ä¸ƒå¥— ä¸‹è‚¢é‹å‹•", url: "http://youtu.be/K6JUMXvkPNQ", category: "è‚ŒåŠ›é‹å‹•" },
            { id: '27', title: "ç¬¬å…«å¥— è‚©å¸¶ä¼¸å±•", url: "http://youtu.be/GKjDnTIeSW4", category: "ä¼¸å±•é‹å‹•" },
            { id: '28', title: "æ ¸å¿ƒä¼¸å±•", url: "http://youtu.be/iisYN1qq_fk", category: "ä¼¸å±•é‹å‹•" },
            { id: '29', title: "ä¸‹è‚¢ä¼¸å±•", url: "http://youtu.be/jJjpgNkSXcU", category: "ä¼¸å±•é‹å‹•" },
            { id: '30', title: "å‘·ç™¾äºŒ_ååš¥å¥åº·æ“ å°èªç‰ˆ", url: "https://youtu.be/ZYgjKHwyA4g", category: "å£è…”ååš¥" },
            { id: '31', title: "ç›Šå£éŠ…èº«æ“", url: "https://youtu.be/qZ87nEuBR4E", category: "å£è…”ååš¥" },
            { id: '32', title: "å¤§è…¦ä¿å¥é«”æ“-å®‰èŠå„‡å‹•ä½œç¤ºç¯„", url: "https://youtu.be/RYvpqbo3FAw", category: "å¤§è…¦ä¿å¥" },
            { id: '33', title: "è€æ­Œå¾‹å‹•-ä¸€æ”¯å°é›¨å‚˜", url: "https://youtu.be/XX9RjPxv3Mw", category: "å¥åº·æ“" }
        ];

        // --- åˆå§‹åŒ–è³‡æ–™ ---
        function initApp() {
            // è®€å–æ•™æ¡ˆ
            const storedVideos = localStorage.getItem(VIDEO_STORAGE_KEY);
            if (storedVideos) {
                allVideos = JSON.parse(storedVideos);
            } else {
                allVideos = seedData;
                saveVideos();
            }

            // è®€å–èœå–®
            const storedCart = localStorage.getItem(CART_STORAGE_KEY);
            if (storedCart) {
                cart = JSON.parse(storedCart);
            }

            renderCategoryBtns();
            filterVideos();
            updateCartUI();
            lucide.createIcons();
        }

        function saveVideos() {
            localStorage.setItem(VIDEO_STORAGE_KEY, JSON.stringify(allVideos));
        }

        function saveCart() {
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
        }

        // --- UI æ¸²æŸ“é‚è¼¯ ---
        function renderCategoryBtns() {
            const container = document.getElementById('categoryFilters');
            container.innerHTML = categories.map(cat => `
                <button onclick="filterCategory('${cat}')" 
                    class="whitespace-nowrap px-5 py-2 rounded-xl text-sm font-medium border transition-all
                    ${cat === currentCategory ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-600 border-slate-200 active:bg-slate-50'}">
                    ${cat}
                </button>
            `).join('');
        }

        function filterCategory(cat) {
            currentCategory = cat;
            renderCategoryBtns();
            filterVideos();
        }

        function filterVideos() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allVideos.filter(v => {
                const mSearch = v.title.toLowerCase().includes(term) || v.category.toLowerCase().includes(term);
                const mCat = currentCategory === 'å…¨éƒ¨' || v.category === currentCategory;
                return mSearch && mCat;
            });
            renderVideos(filtered);
        }

        function renderVideos(videoList) {
            const grid = document.getElementById('videoGrid');
            if (videoList.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-400">æ‰¾ä¸åˆ°ç¬¦åˆçš„æ•™æ¡ˆ</div>`;
                return;
            }
            grid.innerHTML = videoList.map(v => {
                const yId = getYoutubeId(v.url);
                const thumb = yId ? `https://img.youtube.com/vi/${yId}/mqdefault.jpg` : '';
                const isInCart = cart.some(item => item.id === v.id);
                return `
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden relative group hover:shadow-md transition-shadow">
                    <div class="relative cursor-pointer aspect-video" onclick="openPreview('${v.title}', '${v.url}')">
                        <img src="${thumb}" alt="${v.title}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/10 flex items-center justify-center">
                            <i data-lucide="play" class="text-white drop-shadow-md" size="40"></i>
                        </div>
                        <span class="absolute top-2 left-2 bg-blue-600/90 text-white px-2 py-0.5 rounded-lg text-[10px] font-bold shadow-sm">
                            ${v.category}
                        </span>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-slate-800 line-clamp-2 h-10 mb-4 text-sm leading-tight">${v.title}</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="addToCart('${v.id}')" 
                                class="flex-1 flex items-center justify-center gap-1 py-2 rounded-xl border transition-all font-bold text-xs
                                ${isInCart ? 'bg-green-600 border-green-600 text-white' : 'bg-blue-50 border-blue-100 text-blue-600'}">
                                <i data-lucide="${isInCart ? 'check' : 'plus'}" size="14"></i>
                                ${isInCart ? 'å·²åœ¨èœå–®' : 'åŠ ä½œæ¥­'}
                            </button>
                            <div class="flex gap-1">
                                <button onclick="copySingleLink('${v.url}')" title="è¤‡è£½é€£çµ" class="p-2 text-slate-400 hover:text-blue-600"><i data-lucide="copy" size="18"></i></button>
                                <button onclick="openEditModal('${v.id}')" title="ç·¨è¼¯" class="p-2 text-slate-400 hover:text-blue-600"><i data-lucide="edit-3" size="18"></i></button>
                                <button onclick="deleteVideo('${v.id}')" title="åˆªé™¤" class="p-2 text-slate-400 hover:text-red-500"><i data-lucide="trash-2" size="18"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- æ ¸å¿ƒåŠŸèƒ½é‚è¼¯ ---
        function getYoutubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function addToCart(id) {
            const video = allVideos.find(v => v.id === id);
            const index = cart.findIndex(item => item.id === id);
            if (index === -1) {
                cart.push(video);
            } else {
                cart.splice(index, 1);
            }
            saveCart();
            updateCartUI();
            filterVideos();
        }

        function updateCartUI() {
            const count = cart.length;
            document.getElementById('cartCount').innerText = count;
            document.getElementById('cartCountMob').innerText = count;
            const container = document.getElementById('cartItems');
            if (count === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400 text-sm">å°šæœªæŒ‘é¸æ•™æ¡ˆ</div>`;
                return;
            }
            container.innerHTML = cart.map(item => `
                <div class="bg-white p-3 border border-slate-100 rounded-xl flex items-center justify-between gap-3 shadow-sm">
                    <span class="text-sm font-medium text-slate-700 truncate flex-1">${item.title}</span>
                    <button onclick="addToCart('${item.id}')" class="text-slate-300 hover:text-red-500 p-1"><i data-lucide="x" size="16"></i></button>
                </div>`).join('');
            lucide.createIcons();
        }

        function saveVideo() {
            const title = document.getElementById('newTitle').value.trim();
            const url = document.getElementById('newUrl').value.trim();
            const category = document.getElementById('newCategory').value;
            const editId = document.getElementById('editId').value;

            if (!title || !url) return alert("è«‹å¡«å¯«æ¨™é¡Œèˆ‡é€£çµ");

            if (editId) {
                // ç·¨è¼¯ç¾æœ‰æ•™æ¡ˆ
                const index = allVideos.findIndex(v => v.id === editId);
                if (index !== -1) {
                    allVideos[index] = { ...allVideos[index], title, url, category };
                }
            } else {
                // æ–°å¢æ•™æ¡ˆ
                const newVideo = {
                    id: Date.now().toString(),
                    title,
                    url,
                    category,
                    createdAt: Date.now()
                };
                allVideos.unshift(newVideo);
            }

            saveVideos();
            closeModal();
            filterVideos();
        }

        function deleteVideo(id) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æ•™æ¡ˆå—ï¼Ÿ")) return;
            allVideos = allVideos.filter(v => v.id !== id);
            cart = cart.filter(item => item.id !== id); // åŒæ­¥ç§»é™¤èœå–®å…§å®¹
            saveVideos();
            saveCart();
            filterVideos();
            updateCartUI();
        }

        function openEditModal(id) {
            const v = allVideos.find(i => i.id === id);
            document.getElementById('modalTitle').innerText = "ç·¨è¼¯æ•™æ¡ˆå…§å®¹";
            document.getElementById('editId').value = v.id;
            document.getElementById('newTitle').value = v.title;
            document.getElementById('newUrl').value = v.url;
            document.getElementById('newCategory').value = v.category;
            openModal();
        }

        function openModal() {
            if (!document.getElementById('editId').value) {
                document.getElementById('modalTitle').innerText = "æ–°å¢æ•™æ¡ˆ";
            }
            document.getElementById('videoModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('videoModal').style.display = 'none';
            document.getElementById('editId').value = '';
            document.getElementById('newTitle').value = '';
            document.getElementById('newUrl').value = '';
        }

        function toggleCart() {
            document.getElementById('cartSidebar').classList.toggle('translate-x-full');
        }

        function openPreview(title, url) {
            const yId = getYoutubeId(url);
            if (!yId) return;
            document.getElementById('previewTitle').innerText = title;
            document.getElementById('previewVideoContainer').innerHTML = `<iframe src="https://www.youtube.com/embed/${yId}?autoplay=1" frameborder="0" allowfullscreen></iframe>`;
            document.getElementById('previewModal').style.display = 'flex';
        }

        function closePreview() {
            document.getElementById('previewVideoContainer').innerHTML = '';
            document.getElementById('previewModal').style.display = 'none';
        }

        function copySingleLink(url) {
            copyToClipboard(url, "é€£çµå·²è¤‡è£½ï¼");
        }

        function exportAssignment() {
            if (cart.length === 0) return alert("èœå–®æ˜¯ç©ºçš„å–”ï¼");
            const msg = document.getElementById('customMsg').value;
            const listText = cart.map((v, i) => `${i+1}. ${v.title}\nğŸ”— ${v.url}`).join('\n\n');
            const fullContent = `ğŸŒŸ ä»Šæ—¥é‹å‹•ä½œæ¥­ ğŸŒŸ\n\n${msg || 'è¨˜å¾—æ¯å¤©å‹•å‹•èº«é«”å–”ï¼'}\n\nå…§å®¹ï¼š\n${listText}\n\nåŠ æ²¹ï¼èº«é«”å¥åº·ï¼Œè¬äº‹å¦‚æ„ â¤ï¸`;
            
            copyToClipboard(fullContent, "ä½œæ¥­å·²è¤‡è£½ï¼è«‹è²¼åˆ° Line å‚³é€ã€‚");
        }

        function copyToClipboard(text, successMsg) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-[100] text-sm font-bold animate-bounce';
            toast.innerText = successMsg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        window.onclick = e => {
            if (e.target == document.getElementById('videoModal')) closeModal();
            if (e.target == document.getElementById('previewModal')) closePreview();
        }

        // å•Ÿå‹•æ‡‰ç”¨
        window.onload = initApp;
    </script>
</body>
</html>
